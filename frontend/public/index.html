<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="TLAirways - Premium Air Travel Experience"
    />
    
    <!-- Content Security Policy for Auth0 and Adobe Analytics -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' 
        https://dev-q6p3jrm5pbykuq23.us.auth0.com 
        https://assets.adobedtm.com 
        https://*.adobedtm.com;
      style-src 'self' 'unsafe-inline' 
        https://fonts.googleapis.com 
        https://dev-q6p3jrm5pbykuq23.us.auth0.com;
      font-src 'self' 
        https://fonts.gstatic.com 
        https://dev-q6p3jrm5pbykuq23.us.auth0.com;
      img-src 'self' data: blob: 
        https://dev-q6p3jrm5pbykuq23.us.auth0.com 
        https://assets.adobedtm.com 
        https://*.adobedtm.com 
        https://images.unsplash.com 
        https://*.unsplash.com 
        https://www.gravatar.com 
        https://*.gravatar.com;
      connect-src 'self' 
        https://dev-q6p3jrm5pbykuq23.us.auth0.com 
        https://*.auth0.com 
        https://api.tlairways.com 
        https://assets.adobedtm.com 
        https://*.adobedtm.com 
        https://*.adobe.com 
        https://*.demdex.net 
        https://adobedc.demdex.net 
        https://edge.adobedc.net;
      frame-src 'self' 
        https://dev-q6p3jrm5pbykuq23.us.auth0.com 
        https://*.auth0.com 
        https://assets.adobedtm.com 
        https://*.adobedtm.com;
      object-src 'none';
      base-uri 'self';
      form-action 'self' https://dev-q6p3jrm5pbykuq23.us.auth0.com;
    ">
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>TLAirways</title>

    <!-- Adobe Target Pre-hiding Snippet -->
    <script>
      (function(e,a,n,t){
        var i=e.head;
        if(i){
          if(a) return;
          var o=e.createElement("style");
          o.id="alloy-prehiding",o.innerText=n,i.appendChild(o),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},t)
        }
      })(document, document.location.href.indexOf("adobe_authoring_enabled") !== -1, ".personalization-container { opacity: 0 !important }", 3000);
    </script>
    
    <!-- Adobe Launch/DTM Script - Consent Managed Loading -->
    <script>
      (function() {
        var CONSENT_STORAGE_KEY = 'tlairways_consent_preferences';
        var CUSTOM_SCRIPT_KEY = 'tlairways_adobe_script_url';
        var CUSTOM_ATTR_KEY = 'tlairways_adobe_script_attributes';
        var DEFAULT_SCRIPT_URL = 'https://assets.adobedtm.com/01296dd00565/26201e3c8f15/launch-2f8b80d50cb3-development.min.js';
        var DEFAULT_ATTRIBUTES = {
          async: true,
          crossOrigin: 'anonymous'
        };
        var SCRIPT_ID = 'tlairways-adobe-launch';

        var currentScript = null;

        function safeParseJSON(value) {
          if (!value) return null;
          try {
            return JSON.parse(value);
          } catch (e) {
            console.warn('‚ö†Ô∏è Failed to parse stored JSON value:', e);
            return null;
          }
        }

        function getConsentState() {
          try {
            return safeParseJSON(localStorage.getItem(CONSENT_STORAGE_KEY));
          } catch (error) {
            console.warn('‚ö†Ô∏è Unable to read consent preferences:', error);
            return null;
          }
        }

        function hasAdobeConsent(state) {
          if (!state || !state.preferences) return false;
          var prefs = state.preferences;
          return !!(prefs.analytics || prefs.marketing);
        }

        function getScriptConfig() {
          var customUrl = null;
          var customAttrs = null;

          try {
            customUrl = localStorage.getItem(CUSTOM_SCRIPT_KEY);
            customAttrs = safeParseJSON(localStorage.getItem(CUSTOM_ATTR_KEY));
          } catch (error) {
            console.warn('‚ö†Ô∏è Unable to read Adobe script config:', error);
          }

          return {
            url: customUrl || DEFAULT_SCRIPT_URL,
            attrs: { ...DEFAULT_ATTRIBUTES, ...(customAttrs || {}) }
          };
        }

        function buildScriptElement(url, attrs) {
          var script = document.createElement('script');
          script.id = SCRIPT_ID;
          script.src = url;
          script.dataset.tlAdobeLaunch = 'true';

          if (attrs.async) script.async = true;
          if (attrs.defer) script.defer = true;
          if (attrs.crossOrigin) script.crossOrigin = attrs.crossOrigin;

          script.onload = function() {
            window.__tlAdobeLaunchLoaded = true;
            console.log('‚úÖ Adobe Launch script loaded:', url);
          };

          script.onerror = function() {
            console.error('‚ùå Failed to load Adobe Launch script:', url);
            if (url !== DEFAULT_SCRIPT_URL) {
              console.log('üîÑ Attempting default Adobe Launch script...');
              if (script.parentNode) {
                script.parentNode.removeChild(script);
              }
              var fallbackScript = buildScriptElement(DEFAULT_SCRIPT_URL, DEFAULT_ATTRIBUTES);
              currentScript = fallbackScript;
              document.head.appendChild(fallbackScript);
            }
          };

          return script;
        }

        function injectScript() {
          if (document.getElementById(SCRIPT_ID)) {
            console.log('‚ÑπÔ∏è Adobe Launch already injected.');
            return { alreadyLoaded: true };
          }

          var config = getScriptConfig();
          var script = buildScriptElement(config.url, config.attrs);
          currentScript = script;
          document.head.appendChild(script);
          return { success: true };
        }

        function removeScript() {
          var existing = document.getElementById(SCRIPT_ID) || document.querySelector('script[src*="adobedtm.com"]');
          if (existing) {
            existing.parentNode.removeChild(existing);
            currentScript = null;
            window.__tlAdobeLaunchLoaded = false;
            console.log('üõë Adobe Launch script removed pending consent.');
          }
        }

        function init() {
          console.log('üöÄ Adobe Launch consent loader initializing...');
          
          // ALWAYS load Adobe Launch - let defaultConsent control data collection
          // Blocking the script entirely prevents Target/Analytics from initializing
          var consentState = getConsentState();
          var hasConsent = hasAdobeConsent(consentState);
          
          console.log('üìä Consent state:', {
            hasStoredConsent: !!consentState,
            hasAnalyticsConsent: hasConsent,
            willLoadLaunch: true  // Always true now
          });
          
          // Load Adobe Launch unconditionally
          // The Web SDK will read defaultConsent from data layer to control tracking
          injectScript();
        }

        window.__tlConsentScriptLoader = {
          loadAdobeLaunch: function(force) {
            if (!force && document.getElementById(SCRIPT_ID)) {
              return { alreadyLoaded: true };
            }
            return injectScript();
          },
          disableAdobeLaunch: function() {
            removeScript();
          },
          getConsentState: getConsentState,
          canLoadAdobeLaunch: hasAdobeConsent
        };

        init();
      })();
    </script>

  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html> 